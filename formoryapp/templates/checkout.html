{% extends "main.html" %} 
{% load static %}
 
{% block content %}
<style>
/* üåü Modern, Attractive Checkout Styling */
body {
  background: linear-gradient(120deg, #e3f2fd, #ffffff);
  font-family: "Poppins", sans-serif;
}
 
.card {
  border: none !important;
  border-radius: 14px !important;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(14px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
 
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
}
 
.card-body h6 {
  font-weight: 600;
  color: #0a3d62;
  margin-bottom: 12px;
}
 
label {
  font-weight: 500;
  color: #34495e;
}
 
input.form-control,
textarea.form-control {
  border-radius: 10px;
  border: 1px solid #ced4da;
  padding: 10px 12px;
  transition: 0.3s ease;
}
 
input.form-control:focus,
textarea.form-control:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.25);
}
 
textarea.form-control {
  min-height: 80px;
  resize: vertical;
}
 
.table {
  border-radius: 10px;
  overflow: hidden;
  background-color: #fff;
}
 
.table th {
  background: #f1f7ff;
  color: #333;
  text-transform: uppercase;
  font-size: 13px;
}
 
.table td {
  vertical-align: middle;
}
 
.table img {
  border-radius: 8px;
  object-fit: cover;
}
 
/* üß≠ Make rows clickable and highlight on hover */
.clickable-row {
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.2s ease;
}
.clickable-row:hover {
  background-color: #eaf4ff;
  transform: scale(1.01);
}
 
.btn {
  border-radius: 8px;
  font-weight: 500;
  transition: 0.3s ease;
}
 
.btn-success {
  background: linear-gradient(90deg, #28a745, #34d058);
  border: none;
}
 
.btn-success:hover {
  background: linear-gradient(90deg, #34d058, #28a745);
  transform: translateY(-2px);
}
 
.btn-primary {
  background: linear-gradient(90deg, #007bff, #00b4ff);
  border: none;
}
 
.btn-primary:hover {
  background: linear-gradient(90deg, #00b4ff, #007bff);
  transform: translateY(-2px);
}
 
.checkoutform .col-md-6,
.checkoutform .col-md-12 {
  margin-bottom: 12px;
}
 
/* Responsive layout */
@media (max-width: 768px) {
  .card-body {
    padding: 1.2rem !important;
  }
}
</style>
 
<div class="container mt-4 mb-5">
<form id="checkoutForm" action="{% url 'place-order' %}" method="POST">
    {% csrf_token %}
<div class="row g-4">
<!-- Shipping Form -->
<div class="col-md-7">
<div class="card shadow">
<div class="card-body">
<h6>üìù Basic Details</h6>
<hr>
<div class="row checkoutform">
<div class="col-md-6">
<label>First Name</label>
<input type="text" required value="{{ request.user.first_name }}" class="form-control" name="fname">
</div>
<div class="col-md-6">
<label>Last Name</label>
<input type="text" required value="{{ request.user.last_name }}" class="form-control" name="lname">
</div>
<div class="col-md-6">
<label>Email</label>
<input type="text" required value="{{ request.user.email }}" class="form-control" name="email">
</div>
<div class="col-md-6">
<label>Phone</label>
<input type="text" required value="{{ userprofile.phone }}" class="form-control" name="phone">
</div>
<div class="col-md-12 mt-2">
<label>Address</label>
<textarea required class="form-control" name="address">{{ userprofile.address }}</textarea>
</div>
<div class="col-md-6">
<label>City</label>
<input type="text" required value="{{ userprofile.city }}" class="form-control" name="city">
</div>
<div class="col-md-6">
<label>State</label>
<input type="text" required value="{{ userprofile.state }}" class="form-control" name="state">
</div>
<div class="col-md-6">
<label>Country</label>
<input type="text" required value="{{ userprofile.country }}" class="form-control" name="country">
</div>
<div class="col-md-6">
<label>Pin Code</label>
<input type="text" required value="{{ userprofile.pincode }}" class="form-control" name="pincode">
</div>
</div>
</div>
</div>
</div>
 
<!-- Order Summary -->
<div class="col-md-5">
<div class="card shadow">
<div class="card-body">
<h6>üõí Order Summary</h6>
<hr>
{% if cartitems %}
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>Image</th>
<th>Name</th>
<th>Qty</th>
<th>Price</th>
</tr>
</thead>
<tbody>
{% for item in cartitems %}
{% if item.product and item.product.category %}
<tr class="clickable-row" onclick="window.location='{% url 'productview' item.product.category.slug item.product.slug %}'">
  <td><img src="{{ item.product.product_image.url }}" height="50" width="50"></td>
  <td>{{ item.product.name }}</td>
  <td>{{ item.product_qty }}</td>
  <td>‚Çπ{{ item.product.selling_price|stringformat:'d' }}</td>
</tr>
{% endif %}
{% endfor %}
</tbody>
</table>
 
<h6 class="mt-3">
  Grand Total
  <span class="float-end text-success fw-bold">‚Çπ{{ total_price|stringformat:'d' }}</span>
</h6>
<input type="hidden" name="payment_mode" value="COD">
<input type="hidden" name="payment_id" value="">
<input type="hidden" name="order_id" value="">
<input type="hidden" name="signature" value="">
 
<div class="mt-4 d-grid gap-2">
  <button type="submit" class="btn btn-success">COD | Place Order</button>
  <button type="button" class="btn btn-primary PayWithRazorpay">Pay with Razorpay</button>
</div>
{% else %}
<h4>Your Cart is Empty</h4>
{% endif %}
</div>
</div>
</div>
</div>
</form>
</div>
{% endblock content %}
 
{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 
<script>
document.querySelector('.PayWithRazorpay').onclick = function(e) {
  e.preventDefault();
 
  fetch("{% url 'proceed_to_pay' %}", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" }
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      Swal.fire("Error", data.error, "error");
      return;
    }
 
    var options = {
      "key": "{{ razorpay_key }}",
      "amount": data.amount,
      "currency": "INR",
      "name": "EconutriCloud",
      "description": "Order Payment",
      "order_id": data.id,
      "handler": function (response){
        document.querySelector('input[name="payment_mode"]').value = "Paid by Razorpay";
        document.querySelector('input[name="payment_id"]').value = response.razorpay_payment_id;
        document.querySelector('input[name="order_id"]').value = response.razorpay_order_id;
        document.querySelector('input[name="signature"]').value = response.razorpay_signature;
        document.getElementById('checkoutForm').submit();
        setTimeout(() => window.location.href = "{% url 'myorders' %}", 1500);
      },
      "prefill": {
        "name": "{{ request.user.first_name }} {{ request.user.last_name }}",
        "email": "{{ request.user.email }}",
        "contact": "{{ userprofile.phone }}"
      },
      "theme": { "color": "#007bff" }
    };
    new Razorpay(options).open();
  });
}
</script>
{% endblock scripts %}
