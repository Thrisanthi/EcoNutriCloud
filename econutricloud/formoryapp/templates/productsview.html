{% extends "main.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --accent:#2b9348; --bg-gradient:linear-gradient(135deg,#f0fff4,#d6f5e1);
  --muted:#6b7280; --card:#fff; --radius:14px;
  --shadow:0 6px 18px rgba(0,0,0,0.08); --maxw:950px;
}
.card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:20px;transition:.3s}
.card:hover{transform:translateY(-3px)}
.muted{color:var(--muted);font-size:13px}
.btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;transition:.3s;font-weight:600}
.btn:hover{background:#238a3d}
.review-card{flex:0 0 300px;margin:0 12px;padding:18px;background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,0.08);transition:.3s}
.review-card:hover{transform:translateY(-4px)}
.reviews-wrapper{position:relative;overflow:hidden}
.reviews{display:flex;transition:transform .5s ease}
.arrow{position:absolute;top:45%;transform:translateY(-50%);background:#fff;border:1px solid #ddd;border-radius:50%;padding:8px 12px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.15);transition:.3s;z-index:10;}
.arrow:hover{background:#f0f0f0}
.arrow.left{left:0}
.arrow.right{right:0}
.review-stars{color:gold;font-size:16px;margin:6px 0}
#summary h2{margin-top:0}
.summary-row{display:flex;align-items:center;gap:8px;margin:5px 0}
.bar{flex:1;height:8px;background:#eee;border-radius:4px;overflow:hidden}
.bar-fill{height:100%;background:gold;width:0}
.stars { font-size: 24px; color: #ccc; cursor: pointer; }
.stars .selected { color: gold; }
</style>

<!-- üß≠ Breadcrumb -->
<div class="py-3" style="background-color:#9dd9ff">
    <div class="container">
        <a class="text-black" href="{% url 'formoryhome' %}">Home/</a>
        <a class="text-black" href="{% url 'category' %}">Collections/</a>
        <a class="text-black" href="{% url 'categoryview' products.category.slug %}">{{ products.category.name }}/</a>
        <a class="text-black" href="{% url 'productview' products.category.slug products.slug %}">{{ products.name }}</a>
    </div>
</div>

<!-- üõí Product Section -->
<div class="py-5">
    <div class="container">
       <div class="row">
          <div class="col-md-12">
            <div class="card shadow product_data">
               <div class="card-body">
                  <div class="row">
                     <div class="col-md-4">
                         {% if products.tag %}
                            <label class="product-viewtag">{{ products.tag }} </label>
                         {% endif %}
                         <img src="{{ products.product_image.url }}" class="w-100" alt="image">
                     </div>
                     <div class="col-md-8">
                        <h2 class="mb-0">
                            {{ products.name }}
                            {% if products.trending %}
                               <label style="font-size:16px;" class="float-end badge bg-danger trending_tag">Trending</label>
                            {% endif %}                      
                        </h2>
                        <hr>
                        <label class="me-3">Original Price:
                            <s>Rs {{ products.original_price|stringformat:"d" }}</s>
                        </label>
                        <label class="fw-bold">Selling Price: Rs {{ products.selling_price|stringformat:"d" }}</label>
                        
                        <!-- ‚≠ê Average Rating -->
                        <div class="my-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= avg_rating %}
                                    <span class="fa fa-star text-warning"></span>
                                {% else %}
                                    <span class="far fa-star text-warning"></span>
                                {% endif %}
                            {% endfor %}
                            <small>({{ avg_rating|default:0 }})</small>
                        </div>

                        <p class="mt-3">{{ products.small_description }}</p>
                        <hr>
                        {% if products.quantity > 0 %}
                           <label class="badge bg-success">In stock</label>
                        {% else %}
                           <label class="badge bg-danger">Out of stock</label>
                        {% endif %}

                        <div class="row mt-2">
                            <div class="col-md-3">
                               {% csrf_token %}
                               <input type="hidden" value="{{ products.id }}" class="prod_id">
                               <label for="Quantity">Quantity</label>
                               <div class="input-group text-center mb-3" style="width:130px;">
                                   <button class="input-group-text decrement-btn">-</button>
                                   <input type="text" name="quantity" class="form-control qty-input text-center" value="1">
                                   <button class="input-group-text increment-btn">+</button>
                               </div>
                            </div>
                            <div class="col-md-9">
                                <br/>
                                {% if products.quantity > 0 %}
                                   <button type="button" class="btn btn-primary me-3 float-start addToCartBtn">
                                       Add to cart <i class="fa fa-shopping-cart"></i>
                                   </button>
                                {% endif %}
                                   <button type="button" class="btn btn-success me-3 float-start addToWishlist">
                                       Add to Wishlist <i class="fa fa-heart"></i>
                                   </button>
                            </div>
                        </div>
                     </div>
                  </div>

                  <!-- üìñ Description -->
                  <div class="col-md-12 mt-3">
                    <hr>
                    <h3>Description</h3>
                    <p class="mt-3">{{ products.description }}</p>
                  </div>

                  <!-- ‚úç Review Section -->
                  <div class="col-md-12 mt-4">
                    <hr>
                    <h4>Submit Your Review</h4>
                    {% if user.is_authenticated %}
                        <form id="reviewForm" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="rating" id="ratingInput">
                            <div class="stars" id="starRating">
                              {% for i in "12345" %}
                                <i class="fa-regular fa-star star" data-value="{{ forloop.counter }}"></i>
                              {% endfor %}
                            </div>
                            <textarea name="comment" class="form-control mt-2" placeholder="Write your review..."></textarea>
                            <button type="submit" class="btn mt-2">Submit Review</button>
                        </form>
                    {% else %}
                        <p><a href="{% url 'login' %}">Login</a> to submit a review.</p>
                    {% endif %}

                    <!-- üìä Reviews Summary -->
                    <section id="summary" class="card mt-4">
                      <h2>Reviews Summary</h2>
                      {% if reviews %}
                        <div id="summary-content">
                          <div style="font-size:18px;margin-bottom:8px">
                            <strong style="font-size:22px">{{ avg_rating|default:0 }}</strong> / 5 
                            <span class="muted">‚Ä¢ {{ reviews.count }} reviews</span>
                          </div>
                          {% for star in "54321" %}
                            {% with star_int=star|stringformat:"i" %}
                              <div class="summary-row">
                                <span style="width:28px">{{ star }}‚òÖ</span>
                                <div class="bar">
                                  <div class="bar-fill" style="width:{{ star_counts.star_int.percent }}%"></div>
                                </div>
                                <span>{{ star_counts.star_int.count }}</span>
                              </div>
                            {% endwith %}
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="muted">No reviews yet.</div>
                      {% endif %}
                    </section>

                    <!-- üìù Reviews Carousel -->
                    <section id="list" class="card">
                      <h2 style="margin:0 0 12px">What People Say</h2>
                      <div class="reviews-wrapper">
                        <div class="arrow left" id="prevBtn">‚ùÆ</div>
                        <div class="reviews" id="reviews-container">
                          {% for review in reviews %}
                            <div class="review-card">
                              <strong>{{ review.user.username }}</strong>
                              <div class="muted" style="font-size:12px">{{ review.created_at|date:"M d, Y" }}</div>
                              <div class="review-stars">
                                {% for i in "12345" %}
                                  {% if forloop.counter <= review.rating %}
                                    ‚òÖ
                                  {% else %}
                                    ‚òÜ
                                  {% endif %}
                                {% endfor %}
                              </div>
                              <p>{{ review.comment }}</p>

                              {% if user == review.user %}
                                <div class="mt-2">
                                  <a href="{% url 'edit_review' review.id %}" class="btn btn-sm btn-warning">Edit</a>
                                  <a href="{% url 'delete_review' review.id %}" 
                                     class="btn btn-sm btn-danger" 
                                     onclick="return confirm('Are you sure you want to delete this review?');">
                                     Delete
                                  </a>
                                </div>
                              {% endif %}
                            </div>
                          {% empty %}
                            <div class="muted">No reviews yet.</div>
                          {% endfor %}
                        </div>
                        <div class="arrow right" id="nextBtn">‚ùØ</div>
                      </div>
                    </section>
                  </div>
               </div>
            </div>
          </div>
       </div>
    </div>
</div>

<!-- üé¨ JS -->
<script>
document.addEventListener("DOMContentLoaded", function(){
  const stars = document.querySelectorAll("#starRating .star");
  const ratingInput = document.getElementById("ratingInput");
  const form = document.getElementById("reviewForm");

  // ‚≠ê Interactive stars
  stars.forEach(star => {
    star.addEventListener("mouseover", () => highlightStars(star.dataset.value));
    star.addEventListener("mouseout", () => highlightStars(ratingInput.value));
    star.addEventListener("click", () => {
      ratingInput.value = star.dataset.value;
      highlightStars(star.dataset.value);
    });
  });

  function highlightStars(count){
    stars.forEach(s => {
      if(s.dataset.value <= count){
        s.classList.add("selected");
      } else {
        s.classList.remove("selected");
      }
    });
  }

  // üì§ Ajax form submit
  if(form){
    form.addEventListener("submit", function(e){
      e.preventDefault();
      const formData = new FormData(form);
      fetch("{% url 'productview' cate_slug=products.category.slug prod_slug=products.slug %}", {
        method: "POST",
        headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          updateProgressBars(data.star_counts, data.avg_rating, data.total_reviews);
          alert("Review submitted!");
        } else {
          alert(data.error || "Something went wrong.");
        }
      });
    });
  }

  // üìä Update progress bars dynamically
  function updateProgressBars(starCounts, avgRating, totalReviews){
    document.querySelector("#summary strong").innerText = avgRating;
    document.querySelector("#summary .muted").innerText = `‚Ä¢ ${totalReviews} reviews`;

    let rows = document.querySelectorAll("#summary .summary-row");
    let stars = [5,4,3,2,1];
    rows.forEach((row, i) => {
      let percent = totalReviews > 0 ? (starCounts[stars[i]].count / totalReviews * 100) : 0;
      row.querySelector(".bar-fill").style.width = percent + "%";
      row.querySelector("span:last-child").innerText = starCounts[stars[i]].count;
    });
  }

  // ‚¨Ö‚û° Carousel
  const container = document.getElementById('reviews-container');
  const wrapper = document.querySelector('.reviews-wrapper');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  let currentX = 0;

  function getCardWidth(){
    const card = container.querySelector('.review-card');
    return card ? card.offsetWidth + 24 : 320;
  }
  function getMaxScroll(){
    return Math.max(0, container.scrollWidth - wrapper.offsetWidth);
  }
  function updateCarousel(){
    const maxScroll = getMaxScroll();
    if(currentX < 0) currentX = 0;
    if(currentX > maxScroll) currentX = maxScroll;
    container.style.transform = `translateX(-${currentX}px)`;
  }
  prevBtn.addEventListener('click', ()=>{ currentX -= getCardWidth(); updateCarousel(); });
  nextBtn.addEventListener('click', ()=>{ currentX += getCardWidth(); updateCarousel(); });
  window.addEventListener('resize', updateCarousel);
});
</script>
{% endblock content %}